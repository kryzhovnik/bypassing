<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Быстрый звонок</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.1/dist/peerjs.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    animation: {
                        'slide-up': 'slideUp 0.5s ease-out',
                    },
                    keyframes: {
                        slideUp: {
                            '0%': { opacity: '0', transform: 'translateY(30px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' }
                        }
                    },
                    backdropBlur: {
                        xs: '2px'
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom styles for complex effects */
        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        /* Mobile full-screen video layout */
        .mobile-full-video {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 50;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-500 to-purple-600 min-h-screen flex items-center justify-center text-gray-800">
    <!-- Desktop welcome card container -->
    <div id="welcomeContainer" class="w-full max-w-4xl p-5 md:p-0">
        <div class="bg-white rounded-2xl p-8 md:p-10 text-center shadow-2xl animate-slide-up">
            <h1 class="text-3xl md:text-4xl font-bold mb-4 gradient-text">Быстрый звонок</h1>
            <p class="text-gray-600 mb-8 text-lg">Мгновенные видеозвонки без регистрации</p>
            
            <div class="bg-gray-50 border-2 border-dashed border-gray-300 rounded-xl p-5 my-8 relative">
                <input type="text" id="roomUrl" readonly value="Создание комнаты..." 
                       class="w-full border-none bg-transparent text-lg font-mono text-center text-gray-600 outline-none">
                <button onclick="copyLink()" id="copyBtn" 
                        class="absolute right-5 top-1/2 transform -translate-y-1/2 bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm transition-all duration-300 hover:scale-105 md:static md:transform-none md:mt-3 md:w-full">
                    Копировать ссылку
                </button>
            </div>
            
            <p id="instructions" class="text-gray-500 mb-6">
                Поделитесь этой ссылкой, чтобы мгновенно начать звонок
            </p>
            
            <div id="status" class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800">
                <span id="statusText">Создание комнаты</span>
                <div class="ml-2 w-4 h-4 border-2 border-indigo-500 border-t-transparent rounded-full animate-spin"></div>
            </div>
            
            <!-- Video Container - Responsive Layout -->
            <div id="videos" class="hidden mt-8 mb-24 md:mb-8">
                <!-- Local Video (Host) - Desktop: centered, Mobile: full screen when connected -->
                <div id="localVideoContainer" class="relative rounded-xl overflow-hidden bg-black aspect-video max-w-xl mx-auto">
                    <video id="localVideo" autoplay muted playsinline class="w-full h-full object-cover"></video>
                    <span class="absolute top-3 left-3 bg-black bg-opacity-70 text-white px-3 py-1 rounded-full text-sm">Вы</span>
                </div>
                
                <!-- Remote Video Placeholder/Container -->
                <div id="remoteVideoContainer" class="relative rounded-xl overflow-hidden bg-black aspect-video w-48 h-36 md:w-full md:h-auto border-2 border-white border-opacity-30 shadow-lg">
                    <video id="remoteVideo" autoplay playsinline class="w-full h-full object-cover"></video>
                    <span class="absolute top-2 left-2 md:top-3 md:left-3 bg-black bg-opacity-70 text-white px-2 py-1 md:px-3 md:py-1 rounded-full text-xs md:text-sm">Собеседник</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Fixed Control Bar -->
    <div id="controls" class="fixed bottom-0 left-0 right-0 hidden justify-center gap-3 p-4 md:p-5 bg-white bg-opacity-95 backdrop-blur-sm border-t border-black border-opacity-10 z-50 shadow-lg pb-safe">
        <button id="muteAudio" onclick="toggleAudio()" 
                class="w-12 h-12 md:w-14 md:h-14 bg-white border-2 border-gray-200 rounded-full flex items-center justify-center text-gray-600 hover:border-indigo-500 hover:scale-110 transition-all duration-300">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                <path d="M13 8c0 .564-.094 1.107-.266 1.613l-.814-.814A4 4 0 0 0 12 8V7a.5.5 0 0 1 1 0zm-5 4c.818 0 1.578-.245 2.212-.667l.718.719a5 5 0 0 1-2.43.923V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 8V7a.5.5 0 0 1 1 0v1a4 4 0 0 0 4 4m3-9v4.879l-1-1V3a2 2 0 0 0-3.997-.118l-.845-.845A3.001 3.001 0 0 1 11 3"/>
                <path d="m9.486 10.607-.748-.748A2 2 0 0 1 6 8v-.878l-1-1V8a3 3 0 0 0 4.486 2.607m-7.84-9.253 12 12 .708-.708-12-12z"/>
            </svg>
        </button>
        
        <button id="muteVideo" onclick="toggleVideo()" 
                class="w-12 h-12 md:w-14 md:h-14 bg-white border-2 border-gray-200 rounded-full flex items-center justify-center text-gray-600 hover:border-indigo-500 hover:scale-110 transition-all duration-300">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M10.961 12.365a2 2 0 0 0 .522-1.103l3.11 1.382A1 1 0 0 0 16 11.731V4.269a1 1 0 0 0-1.406-.913l-3.111 1.382A2 2 0 0 0 9.5 3H4.272l.714 1H9.5a1 1 0 0 1 1 1v6a1 1 0 0 1-.144.518zM1.428 4.18A1 1 0 0 0 1 5v6a1 1 0 0 0 1 1h5.014l.714 1H2a2 2 0 0 1-2-2V5c0-.675.334-1.272.847-1.634zM15 11.73l-3.5-1.555v-4.35L15 4.269zm-4.407 3.56-10-14 .814-.58 10 14z"/>
            </svg>
        </button>
        
        <button onclick="endCall()" 
                class="w-14 h-14 md:w-16 md:h-16 bg-red-500 hover:bg-red-600 text-white rounded-full flex items-center justify-center hover:scale-110 transition-all duration-300">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                <path d="M3.654 1.328a.678.678 0 0 0-1.015-.063L1.605 2.3c-.483.484-.661 1.169-.45 1.77a17.6 17.6 0 0 0 4.168 6.608 17.6 17.6 0 0 0 6.608 4.168c.601.211 1.286.033 1.77-.45l1.034-1.034a.678.678 0 0 0-.063-1.015l-2.307-1.794a.68.68 0 0 0-.58-.122l-2.19.547a1.75 1.75 0 0 1-1.657-.459L5.482 8.062a1.75 1.75 0 0 1-.46-1.657l.548-2.19a.68.68 0 0 0-.122-.58zM1.884.511a1.745 1.745 0 0 1 2.612.163L6.29 2.98c.329.423.445.974.315 1.494l-.547 2.19a.68.68 0 0 0 .178.643l2.457 2.457a.68.68 0 0 0 .644.178l2.189-.547a1.75 1.75 0 0 1 1.494.315l2.306 1.794c.829.645.905 1.87.163 2.611l-1.034 1.034c-.74.74-1.846 1.065-2.877.702a18.6 18.6 0 0 1-7.01-4.42 18.6 18.6 0 0 1-4.42-7.009c-.362-1.03-.037-2.137.703-2.877z"/>
            </svg>
        </button>
    </div>

    <script>
        // Configuration
        const PEERJS_CONFIG = {
            host: '0.peerjs.com',
            port: 443,
            secure: true,
            debug: 1
        };
        
        // State
        let peer = null;
        let currentCall = null;
        let localStream = null;
        let roomId = null;
        let isHost = false;
        let isAudioMuted = false;
        let isVideoMuted = false;
        
        // Generate human-friendly room ID
        function generateRoomId() {
            const adjectives = ['sunny', 'happy', 'bright', 'swift', 'gentle', 'crystal', 'golden', 'silver', 'cosmic', 'stellar'];
            const nouns = ['river', 'mountain', 'ocean', 'forest', 'meadow', 'valley', 'garden', 'stream', 'lake', 'cloud'];
            const adj = adjectives[Math.floor(Math.random() * adjectives.length)];
            const noun = nouns[Math.floor(Math.random() * nouns.length)];
            const num = Math.floor(Math.random() * 1000);
            return `${adj}-${noun}-${num}`;
        }
        
        // Initialize on page load
        async function init() {
            // Check if joining existing room
            const hash = window.location.hash.slice(1);
            if (hash) {
                roomId = hash;
                isHost = false;
            } else {
                roomId = generateRoomId();
                isHost = true;
                window.location.hash = roomId;
            }
            
            // Update UI
            const url = window.location.href;
            document.getElementById('roomUrl').value = url;
            
            // Get user media first
            try {
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                });
                document.getElementById('localVideo').srcObject = localStream;
                
                // Show video immediately in waiting state
                showWaitingState();
                
            } catch (err) {
                console.error('Failed to get media:', err);
                updateStatus('Доступ к камере/микрофону запрещен', 'error');
                return;
            }
            
            // Initialize peer connection
            initPeer();
        }
        
        function initPeer() {
            // Create peer with room ID
            peer = new Peer(roomId, PEERJS_CONFIG);
            
            peer.on('open', (id) => {
                console.log('Connected with ID:', id);
                if (isHost) {
                    updateStatus('Ожидание собеседника...', 'waiting');
                } else {
                    updateStatus('Подключение...', 'waiting');
                    // If not host, try to call the original room ID (host)
                    const hostId = window.location.hash.slice(1); // Original room ID from URL
                    setTimeout(() => makeCall(hostId), 1000);
                }
            });
            
            peer.on('call', (call) => {
                console.log('Incoming call');
                answerCall(call);
            });
            
            peer.on('error', (err) => {
                console.error('Peer error:', err);
                if (err.type === 'unavailable-id' && !isHost) {
                    // Room exists, we're joining - create unique ID for joiner
                    roomId = roomId + '-guest-' + Date.now();
                    peer = new Peer(roomId, PEERJS_CONFIG);
                    initPeer();
                }
            });
        }
        
        function makeCall(targetId) {
            console.log('Calling:', targetId);
            const call = peer.call(targetId, localStream);
            setupCall(call);
        }
        
        function answerCall(call) {
            call.answer(localStream);
            setupCall(call);
        }
        
        function setupCall(call) {
            currentCall = call;
            
            call.on('stream', (remoteStream) => {
                console.log('Got remote stream');
                document.getElementById('remoteVideo').srcObject = remoteStream;
                
                // Transition to connected state with responsive layout
                showConnectedState();
                
                updateStatus('Подключено', 'connected');
                document.getElementById('instructions').style.display = 'none';
                document.getElementById('welcomeContainer').querySelector('.bg-white').style.display = 'none';
            });
            
            call.on('close', () => {
                endCall();
            });
            
            call.on('error', (err) => {
                console.error('Call error:', err);
                updateStatus('Ошибка подключения', 'error');
            });
        }
        
        function showWaitingState() {
            const videos = document.getElementById('videos');
            const controls = document.getElementById('controls');
            const localContainer = document.getElementById('localVideoContainer');
            const remoteContainer = document.getElementById('remoteVideoContainer');
            
            // Show videos and controls
            videos.classList.remove('hidden');
            controls.classList.remove('hidden');
            controls.classList.add('flex');
            
            // Position remote placeholder in bottom-right
            remoteContainer.classList.add('absolute', 'bottom-24', 'right-4', 'md:bottom-5', 'md:right-5');
            remoteContainer.classList.remove('md:w-full', 'md:h-auto');
        }
        
        function showConnectedState() {
            const welcomeContainer = document.getElementById('welcomeContainer');
            const videos = document.getElementById('videos');
            const localContainer = document.getElementById('localVideoContainer');
            const remoteContainer = document.getElementById('remoteVideoContainer');
            const isMobile = window.innerWidth < 768;
            
            if (isMobile) {
                // Mobile: Full screen experience
                welcomeContainer.classList.add('mobile-full-video');
                videos.classList.add('mobile-full-video', 'bg-black');
                videos.classList.remove('mt-8', 'mb-24');
                
                // Remote video takes full screen
                remoteContainer.classList.remove('w-48', 'h-36', 'absolute', 'bottom-24', 'right-4', 'border-2', 'border-white', 'border-opacity-30', 'shadow-lg', 'rounded-xl');
                remoteContainer.classList.add('w-full', 'h-full', 'absolute', 'inset-0');
                
                // Create mobile PiP for local video
                createMobilePiP();
            } else {
                // Desktop: Keep container layout but switch videos
                remoteContainer.classList.remove('absolute', 'bottom-5', 'right-5', 'w-48', 'h-36');
                remoteContainer.classList.add('w-full', 'max-w-4xl', 'mx-auto');
                
                // Hide local video container and create desktop PiP
                localContainer.classList.add('hidden');
                createDesktopPiP();
            }
        }
        
        function createMobilePiP() {
            // Remove existing PiP if any
            const existingPiP = document.querySelector('#localPiP');
            if (existingPiP) existingPiP.remove();
            
            // Create mobile PiP - smaller and positioned above controls
            const pipContainer = document.createElement('div');
            pipContainer.id = 'localPiP';
            pipContainer.className = 'absolute bottom-20 left-4 w-24 h-18 rounded-lg overflow-hidden bg-black border border-white border-opacity-50 shadow-lg z-10';
            
            // Clone local video for PiP
            const pipVideo = document.getElementById('localVideo').cloneNode(true);
            pipVideo.className = 'w-full h-full object-cover';
            pipVideo.srcObject = localStream;
            
            // Add label
            const label = document.createElement('span');
            label.className = 'absolute top-1 left-1 bg-black bg-opacity-70 text-white px-1 py-0.5 rounded text-xs';
            label.textContent = 'Вы';
            
            pipContainer.appendChild(pipVideo);
            pipContainer.appendChild(label);
            document.getElementById('videos').appendChild(pipContainer);
        }
        
        function createDesktopPiP() {
            // Remove existing PiP if any
            const existingPiP = document.querySelector('#localPiP');
            if (existingPiP) existingPiP.remove();
            
            // Create desktop PiP in bottom-left
            const pipContainer = document.createElement('div');
            pipContainer.id = 'localPiP';
            pipContainer.className = 'absolute bottom-5 left-5 w-48 h-36 rounded-xl overflow-hidden bg-black border-2 border-white border-opacity-30 shadow-lg z-10';
            
            // Clone local video for PiP
            const pipVideo = document.getElementById('localVideo').cloneNode(true);
            pipVideo.className = 'w-full h-full object-cover';
            pipVideo.srcObject = localStream;
            
            // Add label
            const label = document.createElement('span');
            label.className = 'absolute top-2 left-2 bg-black bg-opacity-70 text-white px-2 py-1 rounded-full text-sm';
            label.textContent = 'Вы';
            
            pipContainer.appendChild(pipVideo);
            pipContainer.appendChild(label);
            document.getElementById('remoteVideoContainer').appendChild(pipContainer);
        }
        
        function endCall() {
            if (currentCall) {
                currentCall.close();
                currentCall = null;
            }
            
            // Reset to waiting state
            resetToWaitingState();
            updateStatus('Звонок завершен - Ожидание собеседника...', 'waiting');
        }
        
        function resetToWaitingState() {
            // Remove any PiP
            const existingPiP = document.querySelector('#localPiP');
            if (existingPiP) existingPiP.remove();
            
            // Reset containers
            const welcomeContainer = document.getElementById('welcomeContainer');
            const videos = document.getElementById('videos');
            const localContainer = document.getElementById('localVideoContainer');
            const remoteContainer = document.getElementById('remoteVideoContainer');
            
            // Remove mobile full-screen classes
            welcomeContainer.classList.remove('mobile-full-video');
            videos.classList.remove('mobile-full-video', 'bg-black');
            videos.classList.add('mt-8', 'mb-24', 'md:mb-8');
            
            // Reset video containers
            localContainer.classList.remove('hidden');
            
            // Reset remote container to placeholder position
            remoteContainer.classList.remove('w-full', 'h-full', 'absolute', 'inset-0', 'max-w-4xl', 'mx-auto');
            remoteContainer.classList.add('w-48', 'h-36', 'absolute', 'bottom-24', 'right-4', 'md:bottom-5', 'md:right-5', 'border-2', 'border-white', 'border-opacity-30', 'shadow-lg', 'rounded-xl');
            
            // Clear remote video
            document.getElementById('remoteVideo').srcObject = null;
            
            // Show welcome card elements
            document.getElementById('instructions').style.display = 'block';
            document.getElementById('welcomeContainer').querySelector('.bg-white').style.display = 'block';
        }
        
        function toggleAudio() {
            if (localStream) {
                isAudioMuted = !isAudioMuted;
                localStream.getAudioTracks().forEach(track => {
                    track.enabled = !isAudioMuted;
                });
                
                const btn = document.getElementById('muteAudio');
                if (isAudioMuted) {
                    btn.classList.remove('border-gray-200', 'text-gray-600');
                    btn.classList.add('bg-red-500', 'text-white', 'border-red-500');
                } else {
                    btn.classList.remove('bg-red-500', 'text-white', 'border-red-500');
                    btn.classList.add('border-gray-200', 'text-gray-600');
                }
            }
        }
        
        function toggleVideo() {
            if (localStream) {
                isVideoMuted = !isVideoMuted;
                localStream.getVideoTracks().forEach(track => {
                    track.enabled = !isVideoMuted;
                });
                
                const btn = document.getElementById('muteVideo');
                if (isVideoMuted) {
                    btn.classList.remove('border-gray-200', 'text-gray-600');
                    btn.classList.add('bg-red-500', 'text-white', 'border-red-500');
                } else {
                    btn.classList.remove('bg-red-500', 'text-white', 'border-red-500');
                    btn.classList.add('border-gray-200', 'text-gray-600');
                }
            }
        }
        
        function copyLink() {
            const input = document.getElementById('roomUrl');
            input.select();
            document.execCommand('copy');
            
            const btn = document.getElementById('copyBtn');
            btn.textContent = 'Скопировано!';
            btn.classList.add('copied');
            
            setTimeout(() => {
                btn.textContent = 'Копировать ссылку';
                btn.classList.remove('copied');
            }, 2000);
        }
        
        function updateStatus(text, type) {
            const statusEl = document.getElementById('status');
            const statusText = document.getElementById('statusText');
            
            statusText.textContent = text;
            
            // Update classes based on type
            statusEl.className = 'inline-flex items-center px-4 py-2 rounded-full text-sm font-medium';
            
            switch(type) {
                case 'waiting':
                    statusEl.classList.add('bg-yellow-100', 'text-yellow-800');
                    break;
                case 'connected':
                    statusEl.classList.add('bg-green-100', 'text-green-800');
                    break;
                case 'error':
                    statusEl.classList.add('bg-red-100', 'text-red-800');
                    break;
            }
            
            // Remove spinner if connected or error
            if (type === 'connected' || type === 'error') {
                const spinner = statusEl.querySelector('.animate-spin');
                if (spinner) spinner.remove();
            }
        }
        
        // Handle window resize for responsive layout
        window.addEventListener('resize', () => {
            if (currentCall && document.getElementById('remoteVideo').srcObject) {
                // Re-apply connected state layout for new screen size
                showConnectedState();
            }
        });
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (currentCall) currentCall.close();
            if (peer) peer.destroy();
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
        });
        
        // Start the app
        init();
    </script>
</body>
</html>